<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="BNB Chain Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="BNB Chain Documentation Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="BNB Chain Documentation" href="/opensearch.xml"><title data-react-helmet="true">Consensus Engine of BNB Smart Chain | BNB Chain Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://bnb-chain.github.io//docs/learn/consensus"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Consensus Engine of BNB Smart Chain | BNB Chain Documentation"><meta data-react-helmet="true" name="description" content="Abstract"><meta data-react-helmet="true" property="og:description" content="Abstract"><link data-react-helmet="true" rel="shortcut icon" href="/img/icon/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://bnb-chain.github.io//docs/learn/consensus"><link data-react-helmet="true" rel="alternate" href="https://bnb-chain.github.io//docs/learn/consensus" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://bnb-chain.github.io//docs/learn/consensus" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://3LF005YNGZ-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.2cd9bd19.css">
<link rel="preload" href="/assets/js/runtime~main.ae8f5708.js" as="script">
<link rel="preload" href="/assets/js/main.aaeeaebc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/image.png" alt="BNB" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/image.png" alt="BNB" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">BNB Chain Documentation</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">BNB Chain</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bnbIntro">BNB Chain Platform Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">BNB Smart Chain</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bsc-tutorials">Tutorials</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Core Concepts</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/learn/consensus">Consensus Engine</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">BC and BSC Cross-Chain Mechanism</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn/bsc-gov">Governance of BSC</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Develop</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Validator</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Integrate">Integration</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Wallet</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Beacon Chain</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">BNB Sidechain</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Future Developments</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">FAQs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/contribute">How to Contribute</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/more-help">More Help</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Consensus Engine of BNB Smart Chain</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="abstract">Abstract<a aria-hidden="true" class="hash-link" href="#abstract" title="Direct link to heading">‚Äã</a></h2><p>We target to design the consensus engine of BSC(BNB Smart Chain) to achieve the following goals:</p><ol><li>Wait for a few blocks to confirm (should be less than Ethereum 1.0), better no fork in most cases.</li><li>Blocking time should be shorter than Ethereum 1.0, i.e. 5 seconds or less.</li><li>No inflation, the block reward is transaction gas fees.</li><li>As much as compatible as Ethereum.</li><li>With staking and governance as powerful as cosmos.</li></ol><p><a href="https://github.com/ethereum/go-ethereum/wiki/geth" target="_blank" rel="noopener noreferrer">Geth</a> implements two kinds of consensus engines: ethash(based on PoW) and <a href="https://ethereum-magicians.org/t/eip-225-clique-proof-of-authority-consensus-protocol/1853" target="_blank" rel="noopener noreferrer">clique</a>(based on PoA). Ethash is not a fit option for BSC because BSC gives up PoW. Clique has a shorter blocking time and is invulnerable to 51% attack while doing as little to the core data structure as possible to preserve existing Ethereum client compatibility. The shortcoming of PoA is centralization, and the lack of meaningful staking and governance capability on-chain.  On the other hand, the Beacon Chain is built on Cosmos which does have a deployed staking and governance mechanism. Thus here we try to propose a consensus engine that:</p><ul><li>Beacon Chain does the staking and governance parts for BSC.</li><li>ValidatorSet change, double sign slash of BSC is updated through interchain communication.</li><li>Consensus engine of BSC keeps as simple as clique.</li></ul><p>We investigated some popular implementations of PoA consensus and found out that <a href="https://blog.polygon.technology/heimdall-and-bor/" target="_blank" rel="noopener noreferrer">Bor</a> follows a similar design as above. We will borrow a few parts from Bor and propose a new consensus engine to achieve all these goals.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="infrastructure-components">Infrastructure Components<a aria-hidden="true" class="hash-link" href="#infrastructure-components" title="Direct link to heading">‚Äã</a></h2><ol><li><strong>Beacon Chain</strong>. It is responsible for holding the staking function to determine validators of BSC through an independent election, and the election workflow are performed via staking procedure.</li><li><strong>BSC validators</strong>. Validators are responsible for validating transactions and generating blocks, ensuring the network‚Äôs security and the consistency of the ledger. In return, they receive rewards from the gas consumption of transactions.</li><li><strong>Staking dApps on BSC(also named as system contract)</strong>. There are several genesis contracts to help implement staking on BSC. Six classification groups of them:<ul><li><strong>Light client contract</strong>. It is a watcher of distributed consensus process implemented by contract that only validates the consensus algorithm of Beacon Chain.</li><li><strong>Cross Chain Contract</strong>. It is the cross chain communication layer. It will verify the sequence and merkle proof of a cross chain package.</li><li><strong>BSCValidatorSet contract</strong>. It is a watcher of validators change of BSC on Beacon Chain. It will apply the validator set change for BSC. It also stores rewarded gas fee of blocking for validators, and distribute revenue to validators when receiving cross chain package of validatorSet change.</li><li><strong>System Reward contract</strong>. The incentive mechanism for relayers to maintain system contracts. They will get rewards from system reward contract.</li><li><strong>Liveness Slash Contract</strong>. The liveness of BSC relies on validator set can produce blocks timely when it is their turn. Validators can miss their turns due to any reason. This instability of the operation will hurt the performance of the network and introduce more non-deterministic into the system. This contract responsible for recording the missed blocking metrics of each validator. Once the metrics are above the predefined threshold, the blocking reward for validator will not be relayed to BC for distribution but shared with other better validators.</li><li><strong>Other contracts</strong>. The BSC may take advantage of powerful governance of Beacon Chain, for example, propose to change a parameter of system contracts.</li></ul></li></ol><p>Staking and Governance on Beacon Chain is at a higher layer upon consensus. As for Relayer, it is a standalone process and is open about how to implement it. The detail of them will not be included in this doc.</p><p>This doc only focus on the <strong>BSC validators</strong> and <strong>Staking dApps</strong> on BSC parts which are more closely to consensus engine.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="system-reward-distribution">System Reward Distribution<a aria-hidden="true" class="hash-link" href="#system-reward-distribution" title="Direct link to heading">‚Äã</a></h2><p>The system reward structure in BSC is highly configurable. We may adjust the parameters through governance.</p><p>The rewards comes from transaction fees, rewards are distributed based on several(configurable) rules:</p><ol><li>Validator that generate the block will receives 15/16 of the gas fee.</li><li>System reward contract receive 1/16 of the gas fee.</li></ol><p>If the balance of System reward contract is above 100BNB, will not distribute any BNB to it.
The coming section will explain how these contracts distributing reward.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="staking-dapps-on-bsc">Staking dApps on BSC<a aria-hidden="true" class="hash-link" href="#staking-dapps-on-bsc" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="bscvalidatorset-contract"><a href="https://bscscan.com/address/0x0000000000000000000000000000000000001000" target="_blank" rel="noopener noreferrer">BSCValidatorSet contract</a><a aria-hidden="true" class="hash-link" href="#bscvalidatorset-contract" title="Direct link to heading">‚Äã</a></h3><p>It is a watcher of validators change of BSC on Beacon Chain. It implement the following interfaces:</p><ul><li><strong>handleSynPackage(uint8, bytes calldata msgBytes)</strong></li></ul><p><strong>Conditions</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    1. Message sender must CrossChainContract.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>Action</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    1. if the first byte of msgBytes is 0x00, do Actions validators update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. if the first byte of msgBytes is 0x01, do Actions jail.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>Actions jail</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    1. mark the validator as jailed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>Actions validators update</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    1. Do distribue the revenue of validators:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if the revenue is large than 0.1 BNB, will do cross chain transfer to its account on BC, otherwise will transfer to its address on BSC.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. Update the latest validatorSet.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    3. Clean the metrics record on slash contract.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>CurrentValidator() returns ([]address)</strong></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">returns the the consensus address of not jailed validators.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>deposit(address valAddr) external</strong></p><p><strong>Conditions</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    1. The message sender must be the coinbase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. Can only call once in one block.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>Actions</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    1. Increase the revenue of the validator.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="system-reward-contract"><a href="https://bscscan.com/address/0x0000000000000000000000000000000000001002" target="_blank" rel="noopener noreferrer">System Reward contract</a><a aria-hidden="true" class="hash-link" href="#system-reward-contract" title="Direct link to heading">‚Äã</a></h3><p>For now, only <strong>Cross Chain contract</strong> is permitted to call system reward contract. It implement the following interfaces:</p><ul><li><p><strong>claimRewards(address payable to, uint256 amount) external</strong></p><p>  <strong>Conditions</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  1. The message sender must in permission list.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. The amount should be no more than 1 BNB</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  <strong>Actions</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  1. Transfer amount of BNB to specified address</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="liveness-slash-contract"><a href="https://bscscan.com/address/0x0000000000000000000000000000000000001001" target="_blank" rel="noopener noreferrer">Liveness Slash contract</a><a aria-hidden="true" class="hash-link" href="#liveness-slash-contract" title="Direct link to heading">‚Äã</a></h3><p>If a validator failed to produce a block, will record it and finally slash it. It implement the following interfaces:</p><ul><li><p><strong>Slash(validator address) external</strong></p><p>  <strong>Conditions</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  1. The message sender must in coinbase.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. can only call once in one block.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>  <strong>Actions</strong>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  1. increase the missing blocks metrics of the validator by one.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. if the missing blocks metrics is times of 50, will call misdemeanor func of BSCValidatorSet contract to trigger a misdemeanor event and distribute the revenue of the validator to others.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3. if the missing blocks metrics is times of 150, will call felony func of BSCValidatorSet contract to trigger a felony event, not only distribute the revenue of the validator to others, but also kick the validator out of validatorset.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="consensus-protocol">Consensus Protocol<a aria-hidden="true" class="hash-link" href="#consensus-protocol" title="Direct link to heading">‚Äã</a></h2><p>The implement of the consensus engine is named as <strong>Parlia</strong> which is similar to <a href="https://ethereum-magicians.org/t/eip-225-clique-proof-of-authority-consensus-protocol/1853" target="_blank" rel="noopener noreferrer">clique</a>. This doc will focus more on the difference and ignore the common details.</p><p>Before introducing, we would like to clarify some terms:</p><ol><li>Epoch block. Consensus engine will update validatorSet from BSCValidatorSet contract periodly.  For now the period is 200 blocks, a block is called epoch block if the height of it is times of 200.</li><li>Snapshot.  Snapshot is an assistant object that help to store the validators and recent signers of blocks.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="key-features">Key features<a aria-hidden="true" class="hash-link" href="#key-features" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="light-client-security">Light Client Security<a aria-hidden="true" class="hash-link" href="#light-client-security" title="Direct link to heading">‚Äã</a></h4><p>Validators set changes take place at the (epoch+N/2) blocks. (N is the size of validatorset before epoch block). Considering the security of light client, we delay N/2 block to let validatorSet change take place.</p><p>Every epoch block, validator will query the validatorset from contract and fill it in the extra_data field of block header. Full node will verify it against the validatorset in contract. A light client will use it as the validatorSet for next epoch blocks, however, it can not verify it against contract, it have to believe the signer of the epoch block. If the signer of the epoch block write a wrong extra_data, the light client may just go to a wrong chain. If we delay N/2 block to let validatorSet change take place, the wrong
epoch block won‚Äôt get another N/2 subsequent blocks that signed by other validators, so that the light client are free of such attack.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="system-transaction">System Transaction<a aria-hidden="true" class="hash-link" href="#system-transaction" title="Direct link to heading">‚Äã</a></h4><p>The consensus engine may invoke system contracts, such transactions are called system transactions. System transactions is signed by the the validator who is producing the block. For the witness node, will generate the system transactions(without signature) according to its intrinsic logic and compare them with the system transactions in the block before applying them.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="enforce-backoff">Enforce Backoff<a aria-hidden="true" class="hash-link" href="#enforce-backoff" title="Direct link to heading">‚Äã</a></h4><p>In Clique consensus protocol, out-of-turn validators have to wait a randomized amount of time before sealing the block. It is implemented in the client-side node software and works with the assumption that validators would run the canonical version.
However, given that validators would be economically incentivized to seal blocks as soon as possible, it would be possible that the validators would run a modified version of the node software to ignore such a delay. To prevent validator rushing to seal a block, every out-turn validator will get a specified time slot to seal the block. Any block with a earlier blocking time produced by a out-turn validator will be discarded by other witness node.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-produce-a-new-block">How to Produce a New Block<a aria-hidden="true" class="hash-link" href="#how-to-produce-a-new-block" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="step-1-prepare">Step 1: Prepare<a aria-hidden="true" class="hash-link" href="#step-1-prepare" title="Direct link to heading">‚Äã</a></h4><p>A validator node prepares the block header of next block.</p><ul><li>Load snapshot from cache or database,</li><li>If (height % epoch)==0, should fetch ValidatorSet from <code>BSCValidatorSet</code> <a href="https://bscscan.com/address/0x0000000000000000000000000000000000001000" target="_blank" rel="noopener noreferrer">contract</a>.</li><li>Every epoch block, will store validators set message in <code>extraData</code> field of block header to facilitate the implement of light client.</li><li>The coinbase is the address of the validator</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="step2-finalize-and-assemble">Step2: Finalize And Assemble<a aria-hidden="true" class="hash-link" href="#step2-finalize-and-assemble" title="Direct link to heading">‚Äã</a></h4><ul><li>If the validator is not the in turn validator, will call liveness slash contract to slash the expected validator and generate a slashing transaction.</li><li>If there is gas-fee in the block, will distribute <strong>1/16</strong> to system reward contract, the rest go to validator contract.</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="step3-seal">Step3: Seal<a aria-hidden="true" class="hash-link" href="#step3-seal" title="Direct link to heading">‚Äã</a></h4><p>The final step before a validator broadcast the new block.</p><ul><li>Sign all things in block header and append the signature to extraData.</li><li>If it is out of turn for validators to sign blocks, an honest validator it will wait for a random reasonable time.</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-validatereplay-a-block">How to Validate/Replay a block<a aria-hidden="true" class="hash-link" href="#how-to-validatereplay-a-block" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="step1-verify-header">Step1: Verify Header<a aria-hidden="true" class="hash-link" href="#step1-verify-header" title="Direct link to heading">‚Äã</a></h4><p>Verify the block header when receiving a new block.</p><ul><li>Verify the signature of the coinbase is in <code>extraData</code> of the <code>blockheader</code></li><li>Compare the block time of the <code>blockHeader</code> and the expected block time that the signer suppose to use, will deny a <code>blockerHeader</code> that is smaller than expected. It helps to prevent a selfish validator from rushing to seal a block.</li><li>The <code>coinbase</code> should be the signer and the difficulty should be expected value.</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="step2-finalize">Step2: Finalize<a aria-hidden="true" class="hash-link" href="#step2-finalize" title="Direct link to heading">‚Äã</a></h4><ul><li>If it is an epoch block, a validator node will fetch validatorSet from BSCValidatorSet and compare it with extra_data.</li><li>If the block is not generate by inturn validatorvalidaror, will call slash contract.
if there is gas-fee in the block, will distribute 1/16 to system reward contract, the rest go to validator contract.</li><li>The transaction generated by the consensus engine must be the same as the tx in block.</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="signature">Signature<a aria-hidden="true" class="hash-link" href="#signature" title="Direct link to heading">‚Äã</a></h3><p>The signature of the coinbase is in extraData of the blockheader, the structure of extraData is:
epoch block. 32 bytes of extraVanity + N*{20 bytes of validator address} + 65 bytes of signature.
none epoch block. 32 bytes of extraVanity + 65 bytes of signature.
The signed content is the <code>Keccak256</code> of RLP encoded of the block header.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="security-and-finality">Security and Finality<a aria-hidden="true" class="hash-link" href="#security-and-finality" title="Direct link to heading">‚Äã</a></h3><p>Given there are more than 1/2<!-- -->*<!-- -->N+1 validators are honest, PoA based networks usually work securely and properly. However, there are still cases where certain amount Byzantine validators may still manage to attack the network, e.g. through the ‚ÄúClone Attack‚Äù. To secure as much as BC, BSC users are encouraged to wait until receiving blocks sealed by more than 2/3<!-- -->*<!-- -->N+1 different validators. In that way, the BSC can be trusted at a similar security level to BC and can tolerate less than 1/3<!-- -->*<!-- -->N Byzantine validators.</p><p>With 21 validators, if the block time is 5 seconds, the 2/3<!-- -->*<!-- -->N+1 different validator seals will need a time period of (2/3<!-- -->*<!-- -->21+1)<!-- -->*<!-- -->5 = 75 seconds. Any critical applications for BSC may have to wait for 2/3<!-- -->*<!-- -->N+1 to ensure a relatively secure finality. However, besides such an arrangement, BSC does introduce Slashing logic to penalize Byzantine validators for double signing or instability. This Slashing logic will expose the malicious validators in a very short time and make the <a href="https://arxiv.org/pdf/1902.10244.pdf" target="_blank" rel="noopener noreferrer">Clone Attack</a> very hard or extremely non-economic to execute. With this enhancement, 1/2<!-- -->*<!-- -->N+1 or even fewer blocks are enough as confirmation for most transactions.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="potential-issue">Potential Issue<a aria-hidden="true" class="hash-link" href="#potential-issue" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="extending-the-ruling-of-the-current-validator-set-via-temporary-censorship">Extending the ruling of the current validator set via temporary censorship<a aria-hidden="true" class="hash-link" href="#extending-the-ruling-of-the-current-validator-set-via-temporary-censorship" title="Direct link to heading">‚Äã</a></h4><p>If the transaction that updates the validator is sent to the BSC right on the epoch period, then it is possible for the in-turn validator to censor the transaction and not change the set of validators for that epoch. While a transaction cannot be forever censored without the help of other n/2 validators, by this it can extend the time of the current validator set and gain some rewards. In general, the probability of this scheme can increase by colluding with other validators. It is relatively benign issue that a block may be approximately 5 secs and one epoch being 240 blocks, i.e. 20 mins so the validators could only be extended for another 20 mins.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/bnb-chain/bnb-chain.github.io/blob/master/docs/learn/consensus.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/bsc-tutorials"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ <!-- -->Tutorials</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/learn/cross-chain"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Architecture<!-- --> ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#infrastructure-components" class="table-of-contents__link toc-highlight">Infrastructure Components</a></li><li><a href="#system-reward-distribution" class="table-of-contents__link toc-highlight">System Reward Distribution</a></li><li><a href="#staking-dapps-on-bsc" class="table-of-contents__link toc-highlight">Staking dApps on BSC</a><ul><li><a href="#bscvalidatorset-contract" class="table-of-contents__link toc-highlight">BSCValidatorSet contract</a></li><li><a href="#system-reward-contract" class="table-of-contents__link toc-highlight">System Reward contract</a></li><li><a href="#liveness-slash-contract" class="table-of-contents__link toc-highlight">Liveness Slash contract</a></li></ul></li><li><a href="#consensus-protocol" class="table-of-contents__link toc-highlight">Consensus Protocol</a><ul><li><a href="#key-features" class="table-of-contents__link toc-highlight">Key features</a></li><li><a href="#how-to-produce-a-new-block" class="table-of-contents__link toc-highlight">How to Produce a New Block</a></li><li><a href="#how-to-validatereplay-a-block" class="table-of-contents__link toc-highlight">How to Validate/Replay a block</a></li><li><a href="#signature" class="table-of-contents__link toc-highlight">Signature</a></li><li><a href="#security-and-finality" class="table-of-contents__link toc-highlight">Security and Finality</a></li><li><a href="#potential-issue" class="table-of-contents__link toc-highlight">Potential Issue</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/bnbIntro">Introduction</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buildnbuild.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>BuildnBuild Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.bnbchain.org/en/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/bnb-chain" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.com/invite/bnbchain" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/BNBCHAIN" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://t.me/BinanceDEXchange" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Build N Build.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ae8f5708.js"></script>
<script src="/assets/js/main.aaeeaebc.js"></script>
</body>
</html>